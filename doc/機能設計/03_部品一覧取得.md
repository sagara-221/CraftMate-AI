<!-- filepath: c:\Users\sora1\Desktop\myapp\plan_craft\doc\機能設計\03_部品一覧取得.md -->

# 03. 部品一覧取得 機能設計書

## 1. 機能概要

- 指定したplan_idに紐づく部品一覧（部品名・ID・サイズ等）を返却するAPI。
- 事前に部品一覧取得可否確認APIでready: trueの場合のみ利用可能。

## 2. 入出力仕様

### 入力

- HTTPメソッド: GET
- エンドポイント: `/api/{plan_id}/parts`
- パスパラメータ: `plan_id`（画像アップロード時に発行されたUUID）

### 出力

- 成功時: 部品一覧（配列形式、各要素はpart_id, part_name, sizeを含む）（HTTP 200）
- 失敗時: `{ "error": "エラーメッセージ" }`（HTTP 400/404/500）

## 3. 処理フロー

1. plan_id（UUID形式）をバリデーション
   1. UUID形式でない場合は400エラー
2. Google Cloud Storage（バケット名: `plan-craft-test-bucket` ）に 部品一覧ファイル（`plan_id/parts_list.json` ）が存在するか確認
   * 部品一覧ファイルの形式は以下を想定
   ```json
    [
       {
         "name": "天板",
         "shape": "円柱",
         "size": "大",
         "adjacent": [
           "脚1",
           "脚2",
           "脚3",
           "脚4"
         ]
       },
       {
         "name": "脚1",
         "shape": "直方体",
         "size": "中",
         "adjacent": [
           "天板",
           "貫1"
         ]
       },
       ...
    ]
    ```
   1. ファイルが存在しない場合は404エラー
3. 取得したJSONファイルを部品一覧（part_id, part_name, size）に整形
   - 部品一覧は以下の形式を想定
     ```json
     [
       { "part_id": 1, "part_name": "天板", "size": "直径40cm、高さ4cm" },
       { "part_id": 2, "part_name": "脚1", "size": "縦10cm、 横10cm、 高さ40cm" }
     ]
     ```
4. 画像ファイル（plan_id/image.<拡張子>）もGCSから取得する
   1. 画像ファイルが存在しない場合は404エラー
5. 画像ファイルと整形前の部品一覧を入力として、バックグラウンドで22_部品3Dモデル作成処理を開始する
6. 整形した部品一覧を返却する

## 4. バリデーション

- plan_idがUUID形式であること

## 5. エラーハンドリング

| エラーケース                | ステータスコード | レスポンス例                                 | 備考                         |
|----------------------------|------------------|---------------------------------------------|------------------------------|
| plan_idがUUID形式でない    | 400              | { "error": "plan_idがUUID形式ではありません" } | 形式不正                     |
| parts_list.jsonが存在しない| 404              | { "error": "部品リストがまだ生成されていません" } | GCS上にファイルがない         |
| 画像ファイルが存在しない   | 404              | { "error": "画像ファイルが見つかりません" }     | GCS上に画像がない             |
| GCSアクセス失敗・内部エラー| 500              | { "error": "サーバ内部エラー" }             | 予期しない例外                |

## 6. 備考

- 事前に部品一覧取得可否確認API（/api/{plan_id}/parts/ready）でready: trueの場合のみ利用可能
