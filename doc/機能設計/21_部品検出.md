# 21. 部品検出 機能設計書

## 1. 機能概要

- 入力画像からAIを用いて部品を自動検出し、部品リスト（名称・属性・隣接関係など）を生成する。
- Vertex AI Gemini APIを利用し、画像を入力として部品情報を推論する。
- 検出結果はJSON形式で返却・保存する。

## 2. 入力

- 画像データ
  - JPEG/PNG形式

## 3. 出力

- 部品リスト（各部品の名称・属性・隣接関係などを含む辞書配列）
- 例：
```
[
  {
    "name": "天板",
    "shape": "円柱",
    "size": "大",
    "adjacent": ["脚1", "脚2", "脚3", "脚4"]
  },
  {
    "name": "脚1",
    "shape": "直方体",
    "size": "中",
    "adjacent": ["天板", "貫1"]
  },
  ...
]
```

## 4. 主な処理フロー

1. 画像データを受け取る
2. Vertex AI Gemini APIへ画像・システムプロンプト・ユーザープロンプトを送信
3. Gemini APIからの応答（JSON形式）をパース
4. 部品リストとして返却

## 5. 外部連携

- Vertex AI Gemini（Google Cloud）
- システムプロンプトは `sys_prompt/parts_detection.txt` から読み込み
- ユーザープロンプトは `user_prompt/parts_detection.txt` から読み込み

## 6. エラーハンドリング

- Gemini API応答が不正な場合は例外発生（JSONデコード失敗時など）
- 例外発生時はエラーメッセージをログ出力し、呼び出し元で適切に処理

## 7. 備考

- 画像形式はjpg, jpeg, pngに対応
- 出力JSONは後続の3Dモデル推定処理等で利用される
