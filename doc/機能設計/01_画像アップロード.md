<!-- filepath: c:\Users\sora1\Desktop\myapp\plan_craft\doc\機能設計\01_画像アップロード.md -->

# 01. 画像アップロード 機能設計書

## 1. 機能概要

- 画像ファイルを受け取り、Google Cloud Storage（GCS）に保存する。
- 保存後、plan_id（UUID）を発行し、レスポンスとして返却する。
- 画像アップロード後、非同期でVertexAIによる部品検出処理を開始する。

## 2. 入出力仕様

### 入力

- HTTPメソッド: POST
- エンドポイント: `/api/upload`
- Content-Type: `multipart/form-data`
- パラメータ: `file`（アップロードする画像ファイル）

### 出力

- 成功時: `{ "plan_id": "<uuid>" }`（HTTP 200）
- 失敗時: `{ "error": "エラーメッセージ" }`（HTTP 400/500）

## 3. 処理フロー

1. リクエストから画像ファイルを取得
2. 画像ファイルの存在・拡張子・サイズをバリデーション
3. plan_id（UUID）を生成
4. Google Cloud Storage（バケット名: `plan-craft-test-bucket` など）に画像ファイル(配置先パス:`plan_id/image.<拡張子>`)を保存
5. レスポンスとしてplan_idを返却
6. バックグラウンドで21_部品検出処理（VertexAIを利用）を開始する

## 4. バリデーション

- ファイルが添付されていること
- サポートされている拡張子（jpg, jpeg, png）
- ファイルサイズが10MB以下であること

## 5. エラーハンドリング

| エラーケース                      | ステータスコード | レスポンス例                                 | 備考                         |
|-----------------------------------|------------------|---------------------------------------------|------------------------------|
| ファイル未添付                    | 400              | { "error": "ファイルが添付されていません" } | fileパラメータが存在しない   |
| ファイル名なし                    | 400              | { "error": "ファイルが選択されていません" } | filenameが空                 |
| 拡張子不正                        | 400              | { "error": "サポートされていないファイル形式です" } | jpg, jpeg, png以外           |
| ファイル名に拡張子なし            | 400              | { "error": "ファイル名に拡張子がありません" } | .が含まれない                |
| ファイルサイズ超過                | 400              | { "error": "ファイルサイズが大きすぎます" } | 10MB超過時                   |
| GCS保存失敗                       | 500              | { "error": "GCS保存中にエラーが発生しました" } | GCSアップロード例外           |
| その他サーバ内部エラー            | 500              | { "error": "サーバ内部エラー" }             | 予期しない例外                |

## 6. 非同期処理

- 画像アップロード後、部品検出処理（detect_and_save_parts_list）をスレッドで非同期実行
- メイン処理はplan_id返却までで完了

## 7. セキュリティ・認証

- 現状認証なし（将来的に追加可能性あり）
- ファイルサイズ・拡張子チェックによる最低限のセキュリティ担保

## 8. 備考

- 同一ファイルの複数回アップロード時も新たなplan_idを発行
- ファイル名の重複は問題なし
